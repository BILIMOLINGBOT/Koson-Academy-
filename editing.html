<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profilni tahrirlash</title>
  <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .header {
      background-color: #2c2c2c;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 20px;
      font-weight: 500;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }

    .container {
      max-width: 600px;
      margin: 30px auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #333;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 18px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
    }
    
    input[type="file"] {
      border: 1px dashed #4a90e2;
      padding: 12px;
      background-color: #f9f9f9;
      cursor: pointer;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .link-item {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .btn {
      display: inline-block;
      padding: 12px 25px;
      border: none;
      border-radius: 25px;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-save {
      background-color: #4a90e2;
      color: white;
      font-weight: 500;
    }

    .btn-save:hover:not(:disabled) {
      background-color: #3a80d2;
    }
    
    .btn-save:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-add {
      background-color: #e0e0e0;
      color: #333;
      font-size: 14px;
      padding: 8px 15px;
      border-radius: 20px;
    }
    
    #message-box {
        margin-top: 15px;
        padding: 15px;
        border-radius: 8px;
        font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="header">Profilni tahrirlash</div>

  <div class="container">
    <form id="profile-form">
      <label for="fullname">Ism va familiya</label>
      <input type="text" id="fullname" placeholder="Ism Familiya" required>
      
      <label for="username">Username</label>
      <input type="text" id="username" placeholder="@username" required>
      
      <!-- IMAGE UPLOADS -->
      <label for="cover_image">Profil fon rasmi (Banner)</label>
      <input type="file" id="cover_image" accept="image/*">
      
      <label for="profile_picture">Profil rasmi</label>
      <input type="file" id="profile_picture" accept="image/*">
      <!-- END IMAGE UPLOADS -->

      <label for="birthdate">Tug‘ilgan sana</label>
      <input type="date" id="birthdate" required>

      <label for="region">Manzil</label>
      <select id="region" required>
        <option value="">Viloyatni tanlang</option>
        <option>Andijon viloyati</option>
        <option>Buxoro viloyati</option>
        <option>Farg‘ona viloyati</option>
        <option>Jizzax viloyati</option>
        <option>Namangan viloyati</option>
        <option>Navoiy viloyati</option>
        <option>Qashqadaryo viloyati</option>
        <option>Qoraqalpog‘iston Respublikasi</option>
        <option>Samarqand viloyati</option>
        <option>Sirdaryo viloyati</option>
        <option>Surxondaryo viloyati</option>
        <option>Toshkent viloyati</option>
        <option>Toshkent shahri</option>
        <option>Xorazm viloyati</option>
      </select>

      <label for="bio">Bio (maksimal 200 ta belgi)</label>
      <textarea id="bio" maxlength="200" placeholder="O‘zingiz haqingizda qisqa bio yozing..."></textarea>

      <label>Havolalar</label>
      <div class="links" id="links">
        <div class="link-item">
          <input type="url" placeholder="URL manzili" class="link-url">
          <input type="text" placeholder="Nom (masalan: Instagram)" class="link-name">
        </div>
      </div>
      <button type="button" class="btn btn-add" onclick="addLink()">+ Havola qo‘shish</button>

      <br><br>
      <button type="submit" class="btn btn-save" id="save-btn">Saqlash</button>
      
      <div id="message-box" style="display:none;"></div>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js)";
    import { getAuth, signInAnonymously, signInWithCustomToken, setLogLevel } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js)";
    import { getFirestore, doc, setDoc, getDoc } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js)";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js)";

    // Global variables (Canvas mandated)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

    // Firebase Initialization
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    setLogLevel('Debug');

    let userId = null;
    let profileDocRef = null;
    const saveBtn = document.getElementById('save-btn');
    const messageBox = document.getElementById('message-box');
    const profileForm = document.getElementById('profile-form');
    
    // Utility for showing messages
    function showMessage(text, isError = false) {
        messageBox.textContent = text;
        messageBox.style.backgroundColor = isError ? '#f8d7da' : '#d4edda';
        messageBox.style.color = isError ? '#721c24' : '#155724';
        messageBox.style.display = 'block';
        setTimeout(() => messageBox.style.display = 'none', 5000);
    }

    // --- Authentication and Data Pre-filling ---
    async function initFirebaseAndLoadData() {
      saveBtn.disabled = true;
      try {
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }
        
        userId = auth.currentUser?.uid || crypto.randomUUID();
        profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/user_data`);

        await loadExistingData();
        saveBtn.disabled = false;

      } catch (error) {
        console.error("Firebase auth/init xatosi:", error);
        showMessage("Tizimga kirishda yoki ma'lumotlarni yuklashda xato yuz berdi.", true);
      }
    }
    
    async function loadExistingData() {
        const docSnap = await getDoc(profileDocRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('fullname').value = data.fullname || '';
            document.getElementById('username').value = data.username || '';
            document.getElementById('birthdate').value = data.birthdate || '';
            document.getElementById('region').value = data.region || '';
            document.getElementById('bio').value = data.bio || '';
            
            // Load links
            const linksDiv = document.getElementById('links');
            linksDiv.innerHTML = ''; // Clear default link
            if (data.links && Array.isArray(data.links) && data.links.length > 0) {
                data.links.forEach(link => {
                    addLink(link.url, link.name);
                });
            } else {
                addLink(); // Add one empty link if none exist
            }
            showMessage("Ma'lumotlar yuklandi.");
        } else {
            addLink(); // Add one empty link
            showMessage("Yangi profil yaratilmoqda.");
        }
    }

    // --- Image Upload Utility ---
    async function uploadImage(file, fileName) {
        if (!file) return null;

        const storagePath = `users/${userId}/profile_images/${fileName}`;
        const imageRef = ref(storage, storagePath);
        
        await uploadBytes(imageRef, file);
        return await getDownloadURL(imageRef);
    }

    // --- Form Submission Handler ---
    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saqlanmoqda...';

        try {
            // 1. Get non-file data
            const profileData = {
                fullname: document.getElementById('fullname').value,
                username: document.getElementById('username').value,
                birthdate: document.getElementById('birthdate').value,
                region: document.getElementById('region').value,
                bio: document.getElementById('bio').value,
                updatedAt: new Date().toISOString()
            };
            
            // 2. Process links
            const links = [];
            document.querySelectorAll('.link-item').forEach(item => {
                const url = item.querySelector('.link-url').value.trim();
                const name = item.querySelector('.link-name').value.trim();
                if (url && name) {
                    links.push({ url, name });
                }
            });
            profileData.links = links;


            // 3. Handle Image Uploads
            const coverFile = document.getElementById('cover_image').files[0];
            const profilePicFile = document.getElementById('profile_picture').files[0];

            let coverImageUrl = null;
            let profilePicUrl = null;
            
            // Upload cover image if a new file is selected
            if (coverFile) {
                coverImageUrl = await uploadImage(coverFile, 'cover.jpg');
            }
            // Upload profile picture if a new file is selected
            if (profilePicFile) {
                profilePicUrl = await uploadImage(profilePicFile, 'avatar.jpg');
            }
            
            // 4. Update Firestore
            const updatePayload = {
                ...profileData,
                ...(coverImageUrl && { coverImageURL: coverImageUrl }),
                ...(profilePicUrl && { profilePictureURL: profilePicUrl }),
            };
            
            await setDoc(profileDocRef, updatePayload, { merge: true });
            
            showMessage("Profil muvaffaqiyatli saqlandi!");
            // Optionally redirect back to main profile page
            setTimeout(() => window.location.href = "Profil.html", 1500);

        } catch (error) {
            console.error("Ma'lumotlarni saqlashda xato:", error);
            showMessage(`Saqlashda xato: ${error.message}`, true);
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Saqlash';
        }
    });


    // --- Link Management ---
    window.addLink = (url = '', name = '') => {
      const linksDiv = document.getElementById("links");
      const div = document.createElement("div");
      div.classList.add("link-item");
      div.innerHTML = `
        <input type="url" placeholder="URL manzili" class="link-url" value="${url}">
        <input type="text" placeholder="Nom (masalan: Telegram)" class="link-name" value="${name}">
        <button type="button" class="text-red-500 hover:text-red-700 font-bold" onclick="removeLink(this)">X</button>
      `;
      linksDiv.appendChild(div);
    }
    
    window.removeLink = (button) => {
        button.closest('.link-item').remove();
    }
    
    // Start Initialization
    initFirebaseAndLoadData();
  </script>
</body>
</html>

