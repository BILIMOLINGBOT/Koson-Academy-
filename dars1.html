<!DOCTYPE html><html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>So'z tartibi testi</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f1f1f1;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .question {
      margin-bottom: 20px;
    }
    .word-list, .selected-words {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .word {
      padding: 8px 12px;
      background: #eee;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .word:hover {
      background: #ccc;
    }
    .word.used {
      opacity: 0.4;
      pointer-events: none;
    }
    .selected-words .word {
      background: #d1ecf1;
    }
    #checkBtn {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: none;
    }
    #checkBtn:enabled {
      display: inline-block;
    }
    #progress {
      height: 16px;
      background: #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    #progress-inner {
      height: 100%;
      background: #28a745;
      width: 0%;
      transition: width 0.3s;
    }
    #result {
      font-weight: bold;
      font-size: 18px;
      margin-top: 20px;
    }
    .actions {
      margin-top: 20px;
      display: none;
    }
    .actions button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="progress"><div id="progress-inner"></div></div>
    <div id="quiz"></div>
    <button id="checkBtn" disabled>Tekshirish</button>
    <div id="result"></div>
    <div class="actions">
      <button onclick="retry()">Qayta urinish</button>
      <button onclick="nextLesson()">Keyingi dars</button>
      <button onclick="goToMenu()">Menyuga qaytish</button>
    </div>
  </div>  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD0gBUJNcrgvvntcrfKK7Ky8t6_9Qb96Io",
      authDomain: "bilimilova-64833.firebaseapp.com",
      projectId: "bilimilova-64833",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tg = window.Telegram?.WebApp;
    const uid = tg?.initDataUnsafe?.user?.id?.toString() || null;

    const questions = [
      { words: ["am", "I"], answer: "I am" },
      { words: ["a", "He", "teacher", "is"], answer: "He is a teacher" },
      { words: ["We", "happy", "are"], answer: "We are happy" },
    ];

    let current = 0;
    let correct = 0;

    const quiz = document.getElementById("quiz");
    const result = document.getElementById("result");
    const checkBtn = document.getElementById("checkBtn");
    const progress = document.getElementById("progress-inner");
    const actions = document.querySelector(".actions");

    let selected = [];

    function renderQuestion() {
      quiz.innerHTML = "";
      checkBtn.disabled = true;
      selected = [];
      const q = questions[current];
      const qDiv = document.createElement("div");
      qDiv.className = "question";
      const selDiv = document.createElement("div");
      selDiv.className = "selected-words";
      qDiv.appendChild(selDiv);

      const wordDiv = document.createElement("div");
      wordDiv.className = "word-list";

      q.words.sort(() => Math.random() - 0.5).forEach((w) => {
        const span = document.createElement("span");
        span.textContent = w;
        span.className = "word";
        span.onclick = () => {
          span.remove();
          selected.push(w);
          const sel = document.createElement("span");
          sel.textContent = w;
          sel.className = "word";
          sel.onclick = () => {
            sel.remove();
            selected = selected.filter(s => s !== w || s === '');
            renderQuestion();
          }
          selDiv.appendChild(sel);
          if (selected.length === q.words.length) checkBtn.disabled = false;
        };
        wordDiv.appendChild(span);
      });

      qDiv.appendChild(wordDiv);
      quiz.appendChild(qDiv);
    }

    checkBtn.onclick = () => {
      const q = questions[current];
      const userAnswer = selected.join(" ");
      if (userAnswer === q.answer) correct++;
      current++;
      updateProgress();
      if (current < questions.length) renderQuestion();
      else showResult();
    }

    function updateProgress() {
      progress.style.width = `${Math.floor((current / questions.length) * 100)}%`;
    }

    function showResult() {
      result.textContent = `Natija: ${correct} / ${questions.length}`;
      actions.style.display = "block";
      if (uid) {
        const userRef = doc(db, "users", uid);
        getDoc(userRef).then(snap => {
          const old = snap.exists() ? (snap.data().a1_score || 0) : 0;
          setDoc(userRef, { a1_score: correct }, { merge: true });
        });
      } else {
        localStorage.setItem("a1_score", correct);
      }
    }

    window.retry = () => location.reload();
    window.nextLesson = () => location.href = "dars4.html";
    window.goToMenu = () => location.href = "index.html";

    renderQuestion();
  </script></body>
</html>