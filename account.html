<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yangi Video Yuklash</title>
  <style>
    /* ... avvalgi stylelar o'zgarmaydi, faqat quyidagi qo'shimchalarni qo'shamiz ... */
    
    /* Video frame extractor */
    .frame-selector {
      margin-top: 15px;
      background: #1a1a1a;
      border-radius: 12px;
      padding: 15px;
      border: 1px solid #2f3336;
      display: none;
    }
    
    .frame-selector h4 {
      color: #fff;
      margin-bottom: 10px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .frames-container {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 10px 0;
    }
    
    .frame-thumb {
      width: 120px;
      height: 70px;
      border-radius: 6px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
      flex-shrink: 0;
      position: relative;
    }
    
    .frame-thumb:hover {
      border-color: #1da1f2;
      transform: scale(1.05);
    }
    
    .frame-thumb.selected {
      border-color: #1da1f2;
      box-shadow: 0 0 0 2px rgba(29, 161, 242, 0.3);
    }
    
    .frame-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .frame-time {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 10px;
      padding: 2px 4px;
      text-align: center;
    }
    
    .custom-thumbnail {
      margin-top: 15px;
      display: none;
    }
    
    .thumbnail-preview {
      width: 200px;
      height: 120px;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 10px;
      border: 2px solid #2f3336;
    }
    
    .thumbnail-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .thumbnail-options {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .thumbnail-option-btn {
      padding: 8px 16px;
      background: #2f3336;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }
    
    .thumbnail-option-btn:hover {
      background: #444;
    }
    
    .thumbnail-option-btn.active {
      background: #1da1f2;
    }
  </style>
</head>
<body>

  <div class="video-modal-content">
    <!-- ... avvalgi HTML kodlari o'zgarmaydi, faqat quyidagi qismni qo'shamiz ... -->
    
    <div class="video-form-container">
      <div class="video-form-group">
        <div class="video-preview" id="videoPreview">
          <!-- ... avvalgi kod ... -->
        </div>
        
        <!-- Frame selector (video kadrlarini tanlash) -->
        <div class="frame-selector" id="frameSelector">
          <h4>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            Thumbnail tanlash (video kadrlaridan)
          </h4>
          <div class="frames-container" id="framesContainer">
            <!-- Video kadrlari bu yerga yuklanadi -->
          </div>
        </div>
        
        <!-- Custom thumbnail preview -->
        <div class="custom-thumbnail" id="customThumbnail">
          <div class="thumbnail-preview" id="thumbnailPreview">
            <!-- Tanlangan thumbnail bu yerga ko'rsatiladi -->
          </div>
          <div class="thumbnail-options">
            <button class="thumbnail-option-btn active" onclick="selectThumbnailOption('frame')">
              Video kadridan
            </button>
            <button class="thumbnail-option-btn" onclick="selectThumbnailOption('upload')">
              Rasm yuklash
            </button>
          </div>
          <input type="file" id="thumbnailUpload" accept="image/*" style="display: none;">
        </div>
        
        <div id="videoFileInfo" style="display: none;">
          <!-- ... avvalgi kod ... -->
        </div>
      </div>
      
      <!-- ... qolgan form elementlari ... -->
    </div>
  </div>

  <input type="file" id="videoInput" accept="video/*" style="display: none;">

  <script>
    // ========== GLOBAL VARIABLES ==========
    let selectedVideoFile = null;
    let uploadInProgress = false;
    let videoElement = null;
    let videoFrames = [];
    let selectedThumbnail = null;
    let selectedThumbnailOption = 'frame';
    let customThumbnailFile = null;

    // ========== THUMBNAIL FUNCTIONS ==========
    function selectThumbnailOption(option) {
      selectedThumbnailOption = option;
      
      // Active buttonni belgilash
      document.querySelectorAll('.thumbnail-option-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[onclick="selectThumbnailOption('${option}')"]`).classList.add('active');
      
      if (option === 'upload') {
        // Rasm yuklash inputini ochish
        document.getElementById('thumbnailUpload').click();
      }
    }

    // Rasm yuklash
    document.getElementById('thumbnailUpload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        customThumbnailFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
          selectedThumbnail = e.target.result;
          updateThumbnailPreview();
        };
        reader.readAsDataURL(file);
      }
    });

    // Video kadrlarini olish
    function extractVideoFrames(videoElement) {
      videoFrames = [];
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // Canvas o'lchamlarini sozlash
      canvas.width = 240;
      canvas.height = 135; // 16:9 format
      
      const framesContainer = document.getElementById('framesContainer');
      framesContainer.innerHTML = '';
      
      // Video davomiyligini olish
      const duration = videoElement.duration;
      
      // 8 ta tasodifiy kadr olish
      for (let i = 0; i < 8; i++) {
        // Tasodifiy vaqt nuqtasi
        const randomTime = Math.random() * duration;
        
        // Video holatini o'zgartirish
        videoElement.currentTime = randomTime;
        
        // Kadrni chizish uchun kutish
        setTimeout(() => {
          ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
          const frameDataUrl = canvas.toDataURL('image/jpeg', 0.8);
          
          // Kadrni saqlash
          const frame = {
            time: randomTime,
            dataUrl: frameDataUrl,
            formattedTime: formatTime(randomTime)
          };
          videoFrames.push(frame);
          
          // Kadrni DOMga qo'shish
          const frameDiv = document.createElement('div');
          frameDiv.className = 'frame-thumb';
          frameDiv.innerHTML = `
            <img src="${frameDataUrl}" alt="Video kadri">
            <div class="frame-time">${frame.formattedTime}</div>
          `;
          
          // Kadr bosilganda thumbnail tanlash
          frameDiv.addEventListener('click', function() {
            // Oldingi tanlangan kadrni olib tashlash
            document.querySelectorAll('.frame-thumb.selected').forEach(el => {
              el.classList.remove('selected');
            });
            
            // Yangi kadrni tanlash
            this.classList.add('selected');
            selectedThumbnail = frameDataUrl;
            selectedThumbnailOption = 'frame';
            updateThumbnailPreview();
            
            // Active buttonni yangilash
            document.querySelectorAll('.thumbnail-option-btn').forEach(btn => {
              btn.classList.remove('active');
            });
            document.querySelector(`[onclick="selectThumbnailOption('frame')"]`).classList.add('active');
          });
          
          framesContainer.appendChild(frameDiv);
          
          // Birinchi kadrni avtomatik tanlash
          if (i === 0) {
            frameDiv.click();
          }
        }, 100 * i); // Har bir kadr uchun kichik kechikish
      }
      
      // Frame selector ni ko'rsatish
      document.getElementById('frameSelector').style.display = 'block';
      document.getElementById('customThumbnail').style.display = 'block';
    }

    // Vaqtni formatlash (soniya ‚Üí MM:SS)
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Thumbnail preview ni yangilash
    function updateThumbnailPreview() {
      const thumbnailPreview = document.getElementById('thumbnailPreview');
      if (selectedThumbnail) {
        thumbnailPreview.innerHTML = `<img src="${selectedThumbnail}" alt="Thumbnail">`;
      }
    }

    // ========== VIDEO SELECTION HANDLING (YANGILANGAN) ==========
    function checkVideoFormat(file) {
      videoElement = document.createElement('video');
      videoElement.preload = 'metadata';
      
      videoElement.onloadedmetadata = function() {
        window.URL.revokeObjectURL(videoElement.src);
        const videoRatio = videoElement.videoWidth / videoElement.videoHeight;
        const targetRatio = 16/9;
        const ratioDiff = Math.abs(videoRatio - targetRatio);
        
        // Video ma'lumotlarini ko'rsatish
        showVideoDetails(file, videoElement);
        
        // Agar video 16:9 formatda bo'lmasa, ogohlantirish
        if (ratioDiff > 0.1) {
          const confirmUpload = confirm(
            `üìè Video o'lchami: ${videoElement.videoWidth}x${videoElement.videoHeight}\n` +
            `üìê Format: ${videoRatio.toFixed(2)}:1\n` +
            `üéØ Kerakli format: 16:9 (1.78:1)\n\n` +
            `Davom etishni istaysizmi?`
          );
          
          if (!confirmUpload) {
            resetVideoSelection();
            return;
          }
        }
        
        // Video preview yaratish
        createVideoPreview(file);
        
        // Video kadrlarini olish
        setTimeout(() => {
          extractVideoFrames(videoElement);
        }, 500);
        
        // Formani tekshirish
        validateForm();
      };
      
      videoElement.onerror = function() {
        showAlert('‚ùå Video faylni yuklab bo ªlmadi. Boshqa video tanlang.');
        resetVideoSelection();
      };
      
      videoElement.src = URL.createObjectURL(file);
    }

    // ========== VIDEO PREVIEW YARATISH (YANGILANGAN) ==========
    function createVideoPreview(file) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        // Oldingi contentni tozalash
        const oldVideo = videoPreview.querySelector('video');
        if (oldVideo) oldVideo.remove();
        
        // Video elementini yaratish
        const videoEl = document.createElement('video');
        videoEl.src = e.target.result;
        videoEl.controls = true;
        videoEl.style.width = '100%';
        videoEl.style.height = '100%';
        videoEl.style.objectFit = 'contain';
        videoEl.style.backgroundColor = '#000';
        
        // Preview placeholder ni yashirish
        videoPreview.querySelector('.video-preview-placeholder').style.display = 'none';
        
        videoPreview.appendChild(videoEl);
        
        // Video bosilganda kadrlarni qayta yuklash
        videoEl.addEventListener('seeked', function() {
          // Video pozitsiyasi o'zgarganda thumbnail yaratish
          createThumbnailFromCurrentTime(videoEl);
        });
        
        // Yuklash tugmasini matnini o'zgartirish
        finalUploadBtn.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Videoni Yuklash
        `;
      };
      
      reader.onerror = function() {
        showAlert('‚ùå Video faylni o\'qib bo\'lmadi. Boshqa video tanlang.');
        resetVideoSelection();
      };
      
      reader.readAsDataURL(file);
    }

    // Joriy vaqtdan thumbnail yaratish
    function createThumbnailFromCurrentTime(videoElement) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = 240;
      canvas.height = 135;
      
      ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
      
      // Yangi kadrni frames listiga qo'shish
      const frameDataUrl = canvas.toDataURL('image/jpeg', 0.8);
      const newFrame = {
        time: videoElement.currentTime,
        dataUrl: frameDataUrl,
        formattedTime: formatTime(videoElement.currentTime)
      };
      
      // Agar 8 tadan kam kadr bo'lsa, qo'shish
      if (videoFrames.length < 12) {
        videoFrames.push(newFrame);
        
        const framesContainer = document.getElementById('framesContainer');
        const frameDiv = document.createElement('div');
        frameDiv.className = 'frame-thumb';
        frameDiv.innerHTML = `
          <img src="${frameDataUrl}" alt="Video kadri">
          <div class="frame-time">${newFrame.formattedTime}</div>
        `;
        
        frameDiv.addEventListener('click', function() {
          document.querySelectorAll('.frame-thumb.selected').forEach(el => {
            el.classList.remove('selected');
          });
          this.classList.add('selected');
          selectedThumbnail = frameDataUrl;
          selectedThumbnailOption = 'frame';
          updateThumbnailPreview();
        });
        
        framesContainer.appendChild(frameDiv);
      }
    }

    // ========== VIDEO SELECTION RESET (YANGILANGAN) ==========
    function resetVideoSelection() {
      if (uploadInProgress) {
        if (!confirm("‚ö†Ô∏è Yuklash jarayoni davom etmoqda. Video olib tashlashni istaysizmi?")) {
          return;
        }
      }
      
      selectedVideoFile = null;
      videoInput.value = '';
      videoFrames = [];
      selectedThumbnail = null;
      customThumbnailFile = null;
      
      // Fayl ma'lumotlarini yashirish
      videoFileInfo.style.display = 'none';
      videoDetails.style.display = 'none';
      document.getElementById('frameSelector').style.display = 'none';
      document.getElementById('customThumbnail').style.display = 'none';
      
      // Video preview ni asl holiga qaytarish
      const videoEl = videoPreview.querySelector('video');
      if (videoEl) videoEl.remove();
      
      videoPreview.querySelector('.video-preview-placeholder').style.display = 'flex';
      
      // Formani tekshirish
      validateForm();
      
      // Progress va muvaffaqiyat xabarlarini yashirish
      uploadProgress.style.display = 'none';
      successMessage.style.display = 'none';
      uploadInProgress = false;
      
      // Yuklash tugmasini matnini tiklash
      finalUploadBtn.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Videoni Yuklash
      `;
    }

    // ========== UPLOAD HANDLING (YANGILANGAN) ==========
    function handleUpload() {
      // Ma'lumotlarni tekshirish
      const title = videoTitle.value.trim();
      const description = videoDescription.value.trim();
      const keywords = videoKeywords.value.trim();
      
      if (!title) {
        showAlert('‚ö†Ô∏è Iltimos, video sarlavhasini kiriting!');
        videoTitle.focus();
        videoTitle.style.borderColor = '#ff4d4d';
        setTimeout(() => {
          if (videoTitle.value.trim() === '') videoTitle.style.borderColor = '#2f3336';
        }, 2000);
        return;
      }
      
      if (title.length < 5) {
        showAlert('‚ö†Ô∏è Video sarlavhasi kamida 5 ta belgidan iborat bo\'lishi kerak!');
        videoTitle.focus();
        return;
      }
      
      if (!description) {
        showAlert('‚ö†Ô∏è Iltimos, video tavsifini kiriting!');
        videoDescription.focus();
        return;
      }
      
      if (description.length < 10) {
        showAlert('‚ö†Ô∏è Video tavsifi kamida 10 ta belgidan iborat bo\'lishi kerak!');
        videoDescription.focus();
        return;
      }
      
      if (!selectedVideoFile) {
        showAlert('‚ö†Ô∏è Iltimos, video faylni tanlang!');
        return;
      }
      
      // Thumbnail tekshirish
      if (!selectedThumbnail) {
        showAlert('‚ö†Ô∏è Iltimos, thumbnail tanlang!');
        return;
      }
      
      // Video ID yaratish
      const videoId = Date.now();
      
      // Agar custom thumbnail tanlanmagan bo'lsa, video kadridan olingan thumbnail ishlatiladi
      let thumbnailDataUrl = selectedThumbnail;
      
      // Agar custom rasm yuklangan bo'lsa
      if (selectedThumbnailOption === 'upload' && customThumbnailFile) {
        // Custom thumbnail faylni DataURL ga aylantirish
        const reader = new FileReader();
        reader.onload = function(e) {
          thumbnailDataUrl = e.target.result;
          // Video ma'lumotlarini saqlash
          saveVideoData(videoId, title, description, keywords, thumbnailDataUrl);
        };
        reader.readAsDataURL(customThumbnailFile);
      } else {
        // Video kadridan olingan thumbnail ishlatiladi
        saveVideoData(videoId, title, description, keywords, thumbnailDataUrl);
      }
    }

    function saveVideoData(videoId, title, description, keywords, thumbnail) {
      const videoData = {
        id: videoId,
        title: title,
        description: description,
        keywords: keywords.split(',').map(k => k.trim()).filter(k => k),
        status: 'uploading',
        startTime: Date.now(),
        totalTime: 30000, // 30 soniya (simulyatsiya)
        thumbnail: thumbnail, // Foydalanuvchi tanlagan thumbnail
        createdAt: new Date().toISOString(),
        completed: false,
        views: "0",
        timeAgo: "hozirgina",
        likes: 0,
        comments: 0,
        fileName: selectedVideoFile.name,
        fileSize: formatFileSize(selectedVideoFile.size),
        duration: videoElement ? Math.floor(videoElement.duration) : 0,
        resolution: videoElement ? `${videoElement.videoWidth}x${videoElement.videoHeight}` : 'Noma\'lum'
      };
      
      // Yuklash jarayonini boshlash
      startUploadProcess(videoData);
    }

    // ========== VIDEO DETAILS (YANGILANGAN) ==========
    function showVideoDetails(file, videoEl) {
      videoDetails.style.display = 'block';
      
      const duration = Math.floor(videoEl.duration);
      const minutes = Math.floor(duration / 60);
      const seconds = duration % 60;
      
      videoDetailsList.innerHTML = `
        <li>O'lchami: ${videoEl.videoWidth}x${videoEl.videoHeight}</li>
        <li>Hajmi: ${formatFileSize(file.size)}</li>
        <li>Davomiyligi: ${minutes}:${seconds.toString().padStart(2, '0')}</li>
        <li>Format: ${file.type.split('/')[1].toUpperCase()}</li>
        <li>Thumbnail: ${selectedThumbnailOption === 'frame' ? 'Video kadridan' : 'Yuklangan rasm'}</li>
      `;
    }

    // ========== UTILITY FUNCTIONS ==========
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' bytes';
      else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      else return (bytes / 1048576).toFixed(1) + ' MB';
    }

    function showAlert(message) {
      alert(message);
    }
  </script>
</body>
</html>