<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profil - Javlonbek</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f5f5;
    }

    .header {
      background-color: #2c2c2c;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }

    .icon-btn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
    }

    /* Profil fon rasmi joyi */
    .profile-section {
      height: 200px; /* Banner balandligi */
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-color: #2c2c2c; 
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 20px;
    }

    .profile-overlay {
        background: linear-gradient(to top, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0));
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
    }

    .profile-content {
        position: relative;
        z-index: 2;
        display: flex;
        align-items: center;
        gap: 20px;
        color: white;
    }
    
    .profile-image-container {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 4px solid white;
        background-color: #ccc;
        flex-shrink: 0;
        overflow: hidden;
        margin-top: -40px; /* Rasmni banner ustiga chiqarish */
    }

    .profile-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .profile-details {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        width: 100%;
    }

    .profile-name {
      font-size: 24px;
      font-weight: 600;
    }

    .btn {
      padding: 8px 20px;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      font-weight: 500;
    }

    .btn-edit {
      background-color: #4a90e2;
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .content-area {
      padding: 20px;
      background-color: #f5f5f5;
    }

    .profile-info {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    #user-id-display {
        color: #777;
        font-size: 10px;
        margin-top: 5px;
        word-break: break-all;
    }

    /* Loading state */
    .loading {
        text-align: center;
        padding: 40px;
        font-size: 16px;
        color: #555;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="flex gap-4 items-center">
      <button class="icon-btn" onclick="goBack()">‚Üê</button>
      <div id="username-display" class="text-lg font-medium">@username</div>
    </div>
    <div class="flex gap-4 items-center">
      <button class="icon-btn">üîî</button>
      <button class="icon-btn" onclick="openSettings()">‚ãÆ</button>
    </div>
  </div>

  <div id="profile-section" class="profile-section">
    <div class="profile-overlay"></div>
    <div class="profile-content">
        <div id="profile-picture-container" class="profile-image-container">
             <!-- Rasm URL'i JavaScript orqali qo'shiladi -->
        </div>
        <div class="profile-details">
            <div>
                <h1 id="fullname-display" class="profile-name">Foydalanuvchi Nomi</h1>
                <p id="user-id-display">ID: Yuklanmoqda...</p>
            </div>
            <div class="action-buttons">
              <button class="btn btn-edit" onclick="editProfile()">Tahrirlash</button>
            </div>
        </div>
    </div>
  </div>

  <div class="content-area">
    <div id="loading-indicator" class="loading">Ma'lumotlar yuklanmoqda...</div>
    <div id="profile-content-body" style="display:none;">
        <div class="profile-info">
          <p id="location-display">üìç Manzil &nbsp;&nbsp; üíº Kasb</p>
          <p id="birthdate-display"></p>
          <p><strong>Bio:</strong> <span id="bio-display">Bu yerda qisqa bio yozilishi mumkin.</span></p>
          <p><strong>500</strong> Obunachilar &nbsp;&nbsp; <strong>20</strong> Obunalar &nbsp;&nbsp; <strong>30</strong> ta video</p>
        </div>
    
        <div class="flex gap-4 mb-5">
          <button class="btn bg-blue-500 text-white active-tab">Videolar</button>
          <button class="btn bg-gray-300 text-gray-700">Pleylilar</button>
        </div>
    
        <div>
          <p class="text-gray-600">üé¨ Videolar ro'yxati shu yerda chiqadi...</p>
        </div>
    </div>
  </div>

  <button class="fixed bottom-5 right-5 w-14 h-14 rounded-full bg-blue-500 text-white text-3xl shadow-lg hover:bg-blue-600 transition" onclick="uploadVideo()">+</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Global variables (Canvas mandated)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

    // Firebase Initialization
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    setLogLevel('Debug'); // Enable Firestore logs

    let userId = null;

    // --- Authentication and Data Fetching ---
    async function initFirebaseAndFetchData() {
      try {
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }
        
        userId = auth.currentUser?.uid || crypto.randomUUID();
        document.getElementById('user-id-display').textContent = `ID: ${userId}`;

        const profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/user_data`);

        // Real-time listener for profile data
        onSnapshot(profileDocRef, (docSnap) => {
          const loadingIndicator = document.getElementById('loading-indicator');
          const contentBody = document.getElementById('profile-content-body');
          
          if (docSnap.exists()) {
            const data = docSnap.data();
            updateUI(data);
          } else {
            console.log("Hali profil ma'lumotlari mavjud emas.");
            updateUI({ fullname: "Javlonbek", username: "@unknown", bio: "Profilni tahrirlang.", coverImageURL: '', profilePictureURL: '' });
          }
          
          loadingIndicator.style.display = 'none';
          contentBody.style.display = 'block';

        }, (error) => {
          console.error("Firestore ma'lumotlarini yuklashda xato:", error);
          document.getElementById('loading-indicator').textContent = "Ma'lumotlarni yuklashda xato yuz berdi.";
        });

      } catch (error) {
        console.error("Firebase auth/init xatosi:", error);
        document.getElementById('loading-indicator').textContent = "Tizimga kirishda xato. Konsolni tekshiring.";
      }
    }

    function updateUI(data) {
        // Text Data
        document.getElementById('fullname-display').textContent = data.fullname || "Ism qo'yilmagan";
        document.getElementById('username-display').textContent = data.username || "@username";
        document.getElementById('bio-display').textContent = data.bio || "Bio bo'sh";
        document.getElementById('birthdate-display').textContent = data.birthdate ? `üéÇ ${data.birthdate}` : "Tug'ilgan sana qo'yilmagan";
        document.getElementById('location-display').innerHTML = `üìç ${data.region || 'Manzil yoq'} &nbsp;&nbsp; üíº Blogger`;

        // Profile Picture
        const profilePicContainer = document.getElementById('profile-picture-container');
        const defaultAvatar = 'https://placehold.co/80x80/cccccc/333333?text=A';

        if (data.profilePictureURL) {
            profilePicContainer.innerHTML = `<img src="${data.profilePictureURL}" alt="Profil rasmi" class="profile-image" onerror="this.onerror=null; this.src='${defaultAvatar}';">`;
        } else {
            profilePicContainer.innerHTML = `<img src="${defaultAvatar}" alt="Default Avatar" class="profile-image">`;
        }
        
        // Cover Image (Banner)
        const profileSection = document.getElementById('profile-section');
        if (data.coverImageURL) {
            profileSection.style.backgroundImage = `url('${data.coverImageURL}')`;
        } else {
            profileSection.style.backgroundImage = 'none';
            profileSection.style.backgroundColor = '#2c2c2c';
        }
    }
    
    // Start Initialization
    initFirebaseAndFetchData();

    // Global Functions (needed for onclick attributes)
    window.goBack = () => window.history.back();
    window.editProfile = () => window.location.href = "editing.html";
    window.openSettings = () => window.location.href = "setting.html";
    window.uploadVideo = () => window.location.href = "update.html";

  </script>
</body>
</html>

