<!-- ‚úÖ Dars ochilganda keyingisi ochiladi, modalda ball ham chiqadi -->
<body>
  <a href="index.html" class="back-btn">‚Üê Orqaga</a>
  <h1>A1 Darslari</h1>
  <div id="score">Ball: <span id="score-value">0</span></div>
  <div id="progress-container"><div id="progress-bar"></div></div>
  <div id="lessons-list">...</div>
  <div id="toast" class="toast"></div>

  <!-- Modal bilan baho ko‚Äòrsatish -->
  <div id="congrats-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:999;display:flex;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:30px 20px;border-radius:12px;text-align:center;width:90%;max-width:400px;box-shadow:0 10px 30px rgba(0,0,0,0.2);position:relative">
      <button id="close-modal" style="position:absolute;top:10px;right:15px;border:none;background:none;font-size:20px;cursor:pointer">&times;</button>
      <div style="font-size:50px">üéâ</div>
      <h2 style="margin-bottom:10px;">Tabriklaymiz!</h2>
      <p id="modal-msg" style="margin:10px 0;font-size:16px"></p>
      <p style="font-size:16px;margin-bottom:20px">+10 ball qo ªshildi! Umumiy ball: <span id="modal-score"></span></p>
      <button id="continue-btn" style="padding:10px 25px;border:none;border-radius:6px;background:#007bff;color:#fff;font-size:16px;cursor:pointer">Davom etish</button>
    </div>
  </div>

  <script type="module">
    import { app } from './firebase.js';
    import { getFirestore, doc, getDoc, updateDoc, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const db = getFirestore(app);
    const auth = getAuth(app);

    const lessons = document.querySelectorAll('.lesson-btn');
    const progressBar = document.getElementById('progress-bar');
    const scoreValue = document.getElementById('score-value');
    const toast = document.getElementById('toast');
    const modal = document.getElementById('congrats-modal');
    const modalMsg = document.getElementById('modal-msg');
    const modalScore = document.getElementById('modal-score');
    const continueBtn = document.getElementById('continue-btn');
    const closeModal = document.getElementById('close-modal');

    let unlockedLesson = 1;
    let score = 0;
    let nextLessonHref = null;

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    document.body.classList.toggle('dark-mode', prefersDark.matches);
    prefersDark.addEventListener('change', e => {
      document.body.classList.toggle('dark-mode', e.matches);
    });

    onAuthStateChanged(auth, async user => {
      if (!user) {
        showToast("Iltimos, tizimga kiring.");
        setTimeout(() => window.location.href = "index.html", 1000);
        return;
      }

      const uid = user.uid;
      const userRef = doc(db, "users", uid);

      try {
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
          const data = userSnap.data();
          unlockedLesson = data?.progress?.A1 || 1;
          score = data?.score?.A1 || 0;
          scoreValue.textContent = score;

          const lessonsVisited = data?.lessons_visited || [];
          lessons.forEach(btn => {
            const lessonNum = parseInt(btn.dataset.lesson);
            if (lessonsVisited.some(visit => visit.lesson === lessonNum && visit.visited)) {
              btn.classList.add('visited');
            }
            if (lessonNum <= unlockedLesson) {
              btn.classList.remove('locked');
            }
          });
        } else {
          await setDoc(userRef, {
            progress: { A1: 1 },
            score: { A1: 0 },
            lessons_visited: []
          });
        }

        progressBar.style.width = Math.min((unlockedLesson / lessons.length) * 100, 100) + '%';

        lessons.forEach(btn => {
          btn.addEventListener('click', async function (e) {
            const lessonNum = parseInt(this.dataset.lesson);
            if (lessonNum > unlockedLesson) {
              e.preventDefault();
              showToast("Darslarni ketma-ket o ªrganish kerak!");
              return;
            }

            if (!this.classList.contains('visited')) {
              score += 10;
              unlockedLesson++;
              const timestamp = new Date().toISOString();
              scoreValue.textContent = score;
              progressBar.style.width = Math.min((unlockedLesson / lessons.length) * 100, 100) + '%';
              this.classList.add('visited');

              const nextLesson = document.querySelector(`.lesson-btn[data-lesson="${unlockedLesson}"]`);
              if (nextLesson && nextLesson.classList.contains('locked')) {
                nextLesson.classList.remove('locked');
                nextLesson.href = `dars${unlockedLesson}.html`;
              }

              try {
                await updateDoc(userRef, {
                  [`progress.A1`]: unlockedLesson,
                  [`score.A1`]: score,
                  lessons_visited: arrayUnion({ lesson: lessonNum, visited: true, timestamp })
                });
                modalMsg.textContent = `Dars ${lessonNum} yakunlandi.`;
                modalScore.textContent = score;
                modal.style.display = 'flex';
                nextLessonHref = this.href;
                e.preventDefault();
              } catch (error) {
                console.error("Firestore-ga yozishda xato:", error);
                showToast("Xato yuz berdi, qayta urinib ko‚Äòring.");
              }
            }
          });
        });

        continueBtn.addEventListener('click', () => {
          modal.style.display = 'none';
          if (nextLessonHref) {
            window.location.href = nextLessonHref;
          }
        });

        closeModal.addEventListener('click', () => {
          modal.style.display = 'none';
        });

      } catch (error) {
        console.error("Ma'lumotlarni olishda xato:", error);
        showToast("Ma'lumotlarni yuklashda xato yuz berdi.");
      }
    });
  </script>
</body>
