<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>A1 Darslari</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background-color: #fff;
      color: #000;
      transition: 0.3s ease;
    }
    body.dark-mode {
      background-color: #222;
      color: #f4f4f4;
    }
    .back-btn {
      display: inline-block;
      padding: 10px;
      background-color: #007bff;
      color: #fff;
      text-decoration: none;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .lesson-btn {
      display: block;
      margin: 8px 0;
      padding: 12px;
      text-align: center;
      background-color: #007bff;
      color: #fff;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
    }
    .locked {
      background-color: #ccc !important;
      color: #666 !important;
      pointer-events: none;
    }
    #progress-container {
      background: #ddd;
      border-radius: 8px;
      overflow: hidden;
      margin: 15px 0;
    }
    #progress-bar {
      height: 20px;
      background: #007bff;
      width: 0%;
    }
    #score {
      font-weight: bold;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-btn">← Orqaga</a>
  <h1>A1 Darslari</h1>
  <div id="score">Ball: <span id="score-value">0</span></div>
  <div id="progress-container"><div id="progress-bar"></div></div>
  <div id="lessons-list"></div>

  <script type="module">
    import { db, doc, getDoc, setDoc, updateDoc } from './firebase.js';
    import { getTelegramUserId } from './auth.js';

    const lessonsList = document.getElementById('lessons-list');
    const progressBar = document.getElementById('progress-bar');
    const scoreValue = document.getElementById('score-value');
    const totalLessons = 36;
    let unlockedLesson = 1;
    let score = 0;
    const userId = getTelegramUserId();

    const lessons = [
      "To be affirmative", "To be affirmative test", "To be question", "To be question test",
      "To be negative", "To be negative test", "Present continues affirmative", "Present continues affirmative test",
      "Present continues question", "Present continues question test", "Present continues negative", "Present continues negative test",
      "Present simple affirmative", "Present simple affirmative test", "Present simple question", "Present simple question test",
      "Present simple negative", "Present simple negative test", "I have/I have got affirmative", "I have/I have got affirmative test",
      "I have/I have got question", "I have/I have got question test", "I have/I have got negative", "I have/I have got negative test",
      "Past simple affirmative", "Past simple affirmative test", "Past simple question", "Past simple question test",
      "Past simple negative", "Past simple negative test", "Past continuous affirmative", "Past continuous affirmative test",
      "Past continuous question", "Past continuous question test", "Past continuous negative", "Past continuous negative test"
    ];

    async function loadProgress() {
      if (!userId) return;
      const userRef = doc(db, "users", userId);
      const userSnap = await getDoc(userRef);
      if (userSnap.exists()) {
        const data = userSnap.data();
        unlockedLesson = data.unlockedLesson || 1;
        score = data.score || 0;
        scoreValue.textContent = score;
        progressBar.style.width = ((unlockedLesson - 1) / totalLessons) * 100 + '%';
      } else {
        await setDoc(userRef, { unlockedLesson: 1, score: 0 });
      }
      renderLessons();
    }

    async function updateProgress(newUnlockedLesson) {
      if (!userId) return;
      const userRef = doc(db, "users", userId);
      await updateDoc(userRef, {
        unlockedLesson: newUnlockedLesson,
        score: score
      });
    }

    function renderLessons() {
      lessonsList.innerHTML = "";
      for (let i = 0; i < lessons.length; i++) {
        const num = i + 1;
        const a = document.createElement('a');
        a.textContent = `${num}. ${lessons[i]}`;
        a.dataset.lesson = num;
        a.className = 'lesson-btn';
        if (num <= unlockedLesson) {
          a.href = `dars${num}.html`;
        } else {
          a.classList.add('locked');
        }
        a.addEventListener('click', async (e) => {
          if (num > unlockedLesson) {
            e.preventDefault();
            alert("Darslarni ketma-ket oʻrganish kerak");
          } else {
            if (!a.classList.contains('visited')) {
              a.classList.add('visited');
              score += 10;
              scoreValue.textContent = score;
              if (unlockedLesson < totalLessons) {
                unlockedLesson++;
                progressBar.style.width = ((unlockedLesson - 1) / totalLessons) * 100 + '%';
                await updateProgress(unlockedLesson);
                renderLessons();
              }
            }
          }
        });
        lessonsList.appendChild(a);
      }
    }

    // Dark mode
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    document.body.classList.toggle('dark-mode', prefersDark.matches);
    prefersDark.addEventListener('change', (e) => {
      document.body.classList.toggle('dark-mode', e.matches);
    });

    loadProgress();
  </script>
</body>
</html>