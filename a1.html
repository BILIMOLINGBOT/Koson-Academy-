<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A1 Darslari</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script>
  <style>
    /* Your existing CSS remains unchanged */
  </style>
</head>
<body>
  <a href="index.html" class="back-btn">Orqaga</a>
  <h1>A1 Darslari</h1>

  <div id="score">Ball: <span id="score-value">0</span></div>

  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>

  <div id="lessons-list">
    <a href="dars1.html" class="lesson-btn" data-lesson="1">To be affirmative</a>
    <a href="dars2.html" class="lesson-btn locked" data-lesson="2">To be affirmative test</a>
    <!-- Other lesson buttons remain unchanged -->
  </div>

  <div id="lock-message" class="lock-message">Darslarni ketma-ket oʻrganish kerak</div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD0gBUJNcrgvvntcrfKK7Ky8t6_9Qb96Io",
      authDomain: "bilimilova-64833.firebaseapp.com",
      databaseURL: "https://bilimilova-64833-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "bilimilova-64833",
      storageBucket: "bilimilova-64833.firebasestorage.app",
      messagingSenderId: "890689414502",
      appId: "1:890689414502:web:8141d7aab413495c0c14a7",
      measurementId: "G-ZBC8X1VVMZ"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    document.addEventListener('DOMContentLoaded', function () {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
      document.body.classList.toggle('dark-mode', prefersDark.matches);
      prefersDark.addEventListener('change', (e) => {
        document.body.classList.toggle('dark-mode', e.matches);
      });

      const lessons = document.querySelectorAll('.lesson-btn');
      const lockMessage = document.getElementById('lock-message');
      const progressBar = document.getElementById('progress-bar');
      const scoreValue = document.getElementById('score-value');
      let unlockedLesson = 1;
      let score = 0;

      // Authenticate user anonymously
      auth.signInAnonymously().then((userCredential) => {
        const userId = userCredential.user.uid;

        // Reference to user's progress in Realtime Database
        const userProgressRef = database.ref(`users/${userId}/progress`);

        // Load progress from Firebase
        userProgressRef.once('value').then((snapshot) => {
          const progress = snapshot.val();
          if (progress) {
            unlockedLesson = progress.unlockedLesson || 1;
            score = progress.score || 0;
            scoreValue.textContent = score;

            // Update progress bar
            const totalLessons = lessons.length;
            const progressPercent = Math.min(((unlockedLesson - 1) / totalLessons) * 100, 100);
            progressBar.style.width = progressPercent + '%';

            // Unlock lessons based on progress
            lessons.forEach(lesson => {
              const lessonNum = parseInt(lesson.dataset.lesson);
              if (lessonNum <= unlockedLesson) {
                lesson.classList.remove('locked');
                lesson.href = `dars${lessonNum}.html`;
                if (progress.visitedLessons && progress.visitedLessons[lessonNum]) {
                  lesson.classList.add('visited');
                }
              }
            });
          }
        });

        // Handle lesson clicks
        lessons.forEach(lesson => {
          lesson.addEventListener('click', function (e) {
            const lessonNum = parseInt(this.dataset.lesson);
            if (lessonNum > unlockedLesson) {
              e.preventDefault();
              alert("Darslarni ketma-ket oʻrganish kerak");
            } else {
              // Update score and progress
              if (!this.classList.contains('visited')) {
                score += 10;
                scoreValue.textContent = score;
                const totalLessons = lessons.length;
                const progressPercent = Math.min((lessonNum / totalLessons) * 100, 100);
                progressBar.style.width = progressPercent + '%';

                this.classList.add('visited');

                // Save progress to Firebase
                userProgressRef.update({
                  score: score,
                  unlockedLesson: unlockedLesson,
                  [`visitedLessons/${lessonNum}`]: true
                });

                // Unlock next lesson
                if (unlockedLesson < totalLessons) {
                  unlockedLesson++;
                  const nextLesson = document.querySelector(`.lesson-btn[data-lesson="${unlockedLesson}"]`);
                  if (nextLesson && nextLesson.classList.contains('locked')) {
                    nextLesson.classList.remove('locked');
                    nextLesson.href = `dars${unlockedLesson}.html`;

                    // Update Firebase with new unlocked lesson
                    userProgressRef.update({
                      unlockedLesson: unlockedLesson
                    });
                  }
                }
              }
            }
          });
        });
      }).catch((error) => {
        console.error("Authentication error:", error);
      });
    });
  </script>
</body>
</html>