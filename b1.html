<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>B1 Darajasi Darslari</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="firebase.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #fff;
      color: #000;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode {
      background-color: #121212;
      color: #eee;
    }
    .back-btn {
      display: inline-block;
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    .lesson-btn {
      display: block;
      background-color: #007bff;
      color: white;
      padding: 12px 20px;
      margin: 10px 0;
      border-radius: 8px;
      text-decoration: none;
    }
    .lesson-btn.locked {
      background-color: #ccc;
      color: #666;
      cursor: not-allowed;
    }
    #progress-bar {
      width: 100%;
      background-color: #eee;
      height: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    #progress-fill {
      height: 100%;
      width: 0%;
      background-color: #007bff;
      transition: width 0.5s;
    }
    #score {
      font-weight: bold;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-btn">← Orqaga</a>
  <h1>B1 Darajasi Darslari</h1>
  <div id="score">Ball: <span id="point">0</span></div>
  <div id="progress-bar"><div id="progress-fill"></div></div>
  <div id="lessons-list"></div>

  <script type="module">
    import { app, db, auth } from './firebase.js';
    import { doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const lessons = [
      "I'm vs I do", "Question forms", "To either / So am I", "Haven't / Don't / Isn't",
      "Have you ... ?", "Who said you?", "What is it like?", "What? Which? How?",
      "How long does it take?", "Do you know where ... ?", "She said that ...",
      "Work vs Working", "Want to do vs Enjoy doing", "Told you to ...",
      "Went to shop to ...", "Go to / Go on / Go for", "Get a job / Get home",
      "Do vs Make", "Have or Have got", "Pronouns 1", "Pronouns 2", "Whose is this?",
      "Kateʼs camera", "Articles: A and An", "Singular and Plural", "Countable nouns 1",
      "Countable nouns 2", "Some / Any", "Much / Many", "A lot of / Few"
    ];

    const lessonContainer = document.getElementById("lessons-list");
    const progressFill = document.getElementById("progress-fill");
    const pointDisplay = document.getElementById("point");

    let unlocked = 0;
    let score = 0;
    let userId = null;

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        userId = user.uid;
        const docRef = doc(db, "users", userId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          unlocked = data.b1_unlocked || 0;
          score = data.b1_score || 0;
        }
        renderLessons();
        updateProgress();
      }
    });

    async function saveProgress() {
      if (!userId) return;
      const ref = doc(db, "users", userId);
      await setDoc(ref, { b1_unlocked: unlocked, b1_score: score }, { merge: true });
    }

    function updateProgress() {
      const percent = Math.floor((unlocked / lessons.length) * 100);
      progressFill.style.width = percent + "%";
      pointDisplay.textContent = score;
    }

    function renderLessons() {
      lessonContainer.innerHTML = "";
      lessons.forEach((lesson, index) => {
        const btn = document.createElement("a");
        btn.textContent = `${index + 1}. ${lesson}`;
        btn.className = "lesson-btn" + (index <= unlocked ? "" : " locked");
        btn.href = index <= unlocked ? `dars${50 + index}.html` : "#";
        btn.addEventListener("click", async (e) => {
          if (index > unlocked) {
            e.preventDefault();
            alert("Oldingi darslarni tugatish kerak!");
          } else if (index === unlocked) {
            unlocked++;
            score++;
            await saveProgress();
            renderLessons();
            updateProgress();
          }
        });
        lessonContainer.appendChild(btn);
      });
    }

    // Dark mode
    const darkQuery = window.matchMedia("(prefers-color-scheme: dark)");
    document.body.classList.toggle("dark-mode", darkQuery.matches);
    darkQuery.addEventListener("change", e => {
      document.body.classList.toggle("dark-mode", e.matches);
    });
  </script>
</body>
</html>